<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>CLI! CLI! CLI! -- 古い形式のブログ記事を変換するおしごと</title>

        <!-- Fomantic-UI -->
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
        <link rel="stylesheet" type="text/css" href="../css/semantic.min.css">
        <script src="../js/semantic.min.js"></script>

        <!-- Highlight.js -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/night-owl.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <!-- and it's easy to individually load additional languages -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/vim.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>


        <link rel="stylesheet" type="text/css" href="../css/myCustom.css">

	  
	  <meta property="og:type" content="article" /><meta property="og:url" content="https://cj-bc.github.io/blog/posts/2021-12-02-blog-migrate-old-blog-posts.html" /><meta property="og:title" content="古い形式のブログ記事を変換するおしごと" /><meta property="og:description" content="複数のフォーマットに対応したHakyllコードをかくのが そろそろ辛くなってきたからです。 特に、メタデータの取り扱い周りが厄介なのです。" />
	  
	  
	  <meta name="twitter:card" content="summary" />
	  

	<meta name="viewport" content="width=device-width" />
    </head>
    <body>
        <div id="header" class="ui fixed inverted menu">
	  
	  <a href="../" class="mobile only item"><i class="angle left icon"></i></a>
	  
          <div class="computer only item"><img src="https://avatars0.githubusercontent.com/u/16875061?s=460&u=98d9809dd854df3a38568023ebdacc080ffe3fa2&v=4" class="ui avatar image">CLI! CLI! CLI!</div>
          <div class="mobile only item"><img src="https://avatars0.githubusercontent.com/u/16875061?s=460&u=98d9809dd854df3a38568023ebdacc080ffe3fa2&v=4" class="ui avatar image"></div>
            <a href="../" class="computer only item">Home</a>
            <a href="../archive.html" class="item">Archive</a>
            <a href="https://Cj-bc.github.io" class="item">HP</a>
            <a href="https://github.com/Cj-bc/blog" class="item right"><img src="https://github.com/Cj-bc/blog/workflows/Publish/badge.svg"></a>
            <a href="../feeds/atom/general.xml" class="item">Atom feed</a>
            <a href="../feeds/rss/general.xml" class="item"><i class="rss icon"></i></a>
        </div>

	<div id="bodygrid" class="ui three column stackable grid container">
	  <div class="ui four wide computer only column">
	    
	    <div class="ui fluid card">
  <img src="https://avatars0.githubusercontent.com/u/16875061?s=460&u=98d9809dd854df3a38568023ebdacc080ffe3fa2&v=4" class="ui image">
  <div class="content">
    <div class="header">
      Cj.BC_SD
    </div>
    <div class="description">
      This is me
    </div>

    <div class="extra content">
      <div class="ui horizontal list">
	<div class="item">
	  <i class="twitter icon"></i>
	  cj_bc_sd
	</div>
      </div>
    </div>
  </div>
</div>

	    
	  </div>
	  <div class="ui four wide tablet mobile only column">
	    
	    <div class="ui fluid card">
  <div class="content">
    <img src="https://avatars0.githubusercontent.com/u/16875061?s=460&u=98d9809dd854df3a38568023ebdacc080ffe3fa2&v=4" class="ui avatar image"> Cj.BC_SD
    <div class="description">
      This is me
    </div>
  </div>
  <div class="extra content">
      <div class="ui horizontal list">
	<div class="item">
	  <i class="twitter icon"></i>
	  cj_bc_sd
	</div>
      </div>
    </div>
</div>

	    
	  </div>
          <div class="ui eight wide column">
	    <div class="ui secondary segment">
	      <p>
		現在ブログ改修工事中です。恐らく多分きっとメイビーそのうちAstro製の既存デザインへと
		変換しますので、見辛さは今暫くご容赦下さい。
	      </p>
	    </div>

	    <div class="ui fluid card">
	      <div id="body-content">
  <div class="content of Memo">
    <div class="ui center aligned icon header">
      <h1>古い形式のブログ記事を変換するおしごと</h1>
    </div>
      <div class="meta ui list">
	<div class="item">Posted on December  2, 2021</div>
	<div class="item">
	  <i class="history icon"></i>
	  Updated on December 30, 2021
	</div>

	

	
	<a title="All pages tagged 'blog'." href="../tags/blog.html" class="ui tag label">blog</a>
	
      </div>

    <div class="description">
      <h1 id="これまでの遷移">これまでの遷移</h1>
<table class="ui celled table">
<tbody>
<tr class="odd">
<td>blog以前</td>
<td>Qiita flavored markdownでQiitaに投稿</td>
</tr>
<tr class="even">
<td>一番初めの時期(<a href="https://cj-bc.github.io/blog/posts/2020-08-02-helloHakylly.html">2020/08/02</a><code>[[https://cj-bc.github.io/blog/posts/2021-01-19-after-effect-markers.html][2021/01/19]]) | markdown+pandoc拡張(メタデータをyamlで管理) |
   | org移行期([[https://cj-bc.github.io/blog/posts/2021-01-31-org-file-test.html][2021/01/31]]</code>
<a href="https://cj-bc.github.io/blog/posts/2021-05-19-emacs-org-roam-setup.html">2021-05-19</a></td>
<td>Org format(メタデータをyamlで管理</td>
</tr>
<tr class="odd">
<td>現在のフォーマット(<a href="https://cj-bc.github.io/blog/posts/2021-07-24-diary-allelosphere-vol1.html">2021/07/24</a>~)</td>
<td>Org format(メタデータをPropertyで管理)</td>
</tr>
</tbody>
</table>
<h1 id="なぜ移行するのか">なぜ移行するのか</h1>
<p>複数のフォーマットに対応したHakyllコードをかくのが
そろそろ辛くなってきたからです。
特に、メタデータの取り扱い周りが厄介なのです。</p>
<p>Pandocでは、独自の構文としてメタデータを YAML
フォーマットのヘッダーに保存することができます。
昔はこれを使っていたのですが、 Emacs+Org mode
の構成で投稿を作成する際、それらをプロパティとして
扱えたら便利だなと感じるようになりました。</p>
<p>プロパティとして扱える利点としては、例えば現在の投稿にある
<code>BLOG_POST_PROGRESS</code> を <code>org-agenda</code>
から見ることによって、
作成中の投稿の一覧を容易に作成することができます。 これは、org
modeの機能の一つであるプロパティを用いているからできること
であって、pandocのYAML構文を用いようとしたらまた新しいプログラムを
書く必要がでてきます。それは面倒だし非効率なので、
今迄YAMLメタデータとして仕舞っていたデータも
プロパティとして保存するように変更しました。</p>
<p>それに伴い、タイトルの取得の方法等も変わって昔の方法は使えなくなりました。
どちらにも対応することは不可能ではないでしょうが、
正直もう昔の方法を利用することは無いであろうこと・今後のメンテナンス性を
考えると非効率であることから、完全な移行をするに至りました。</p>
<h1 data-header-args=":results raw :noweb yes" id="移行スクリプト">移行スクリプト</h1>
<h2 id="技術選定">技術選定</h2>
<p>今回使っていくのは</p>
<ul>
<li><a href="https://pandoc.org/">pandoc</a></li>
<li><a href="https://www.nushell.sh/">nushell</a></li>
<li>awk</li>
<li>bash</li>
</ul>
<p>です</p>
<p>以下のコード内で、便宜上コードブロックの言語を <code>sh</code>
にしていますが、 一部は実際はnushellのスクリプトです。 (Emacs上でOrg
babelで実行する際は、 <code>:shbang #!/bin/nu</code> の効果で
nushellのスクリプトとして実行されます。)</p>
<ol>
<li><p>pandoc</p>
<p>いわずと知れたフォーマット変換(等)ツール。 今回、markdown→org
formatの変換を必要とするファイルもあるため必須です。
又、整形にも使います。</p></li>
<li><p>nushell</p>
<p>言わずと知れた‥というにはまだ早いので紹介します。
nushellは、色々な新しい面を持ちますが、今回の目的にそった紹介をする
のであればデータ型を持つシェルです。
内部にリストやテーブル・日付型・サイズ型等色々な型を持つほか、 CVSやINI,
TOML, ICS, XML, そして今回の本命YAML等のデータを
取り込むんことができます。</p>
<p>今回はこのYAMLを取り込めるという機能を目的に採用しました。
YAML形式で保存されているメタデータの取り出しから、それを新しいHeadingに
整形する部分までかnushellの役割です。</p>
<ol>
<li><p>経緯</p>
<p>とりあえずpandocを使うことは決定していましたが、
実はpandoc単体(フィルターなし)では「その内容を参照して
あれこれする」ことができません。
というか、そういうニーズを満たすためのものがフィルターなんですが…</p>
<p>でもフィルター書くのはちょっと面倒なんだよね…
今はYAML形式のメタデータの情報を使いたいだけなので、
テキスト処理ならawkなりsedなりあるし
わざわざフィルター書く程のものでもないように感じます。</p>
<p>なので、手軽にYAMLを使えるnushellを使ってみることにしました。</p></li>
</ol></li>
<li><p>awk</p>
<p>文字列処理ならsedかawkでしょ、ということで使用。
今回は、記事からYAML形式のメタデータ部分を取得するために使用します。</p></li>
<li><p>bash</p>
<p>nushellで全てを書こうとしたのですが、いかんせん新しいプロジェクトなので
未だ使い勝手が整ってなかったり出来無いことがあったりします。</p>
<p>私がnushellに慣れていない、というのもありますが、
テキストを読み込んだ時に謎にTableにされてしまい、それを頑張ってテキストに戻して…
みたいなことをやるのに疲れてしまいました。
ということで、nushellの得意な部分はnushellに任せて、他の処理は手慣れたbashで
行おうということになりました。</p></li>
</ol>
<h2 id="1. YAML部分を取り出す">1. YAML部分を取り出す</h2>
<p>ここは単純なテキスト処理なのでawkを使います。(もっと良い方法があれば教えてください)</p>
<p>メタデータは <code>---</code> と <code>---</code>
で囲まれているので、 「 <code>---</code> の次の行から次に
<code>---</code> がくるまで」を出力します。</p>
<div class="ui segment">
<div class="ui top right attached label">
awk
</div>
<div class="sourceCode" id="extract-yaml-metadata" data-in-file="./2021-01-03-fomantic-ui.md" data-results="raw" wrap="SRC yaml"><pre class="sourceCode awk SourceCode"><code class="sourceCode awk"><span id="extract-yaml-metadata-1"><a href="#extract-yaml-metadata-1" aria-hidden="true" tabindex="-1"></a>   <span class="cf">BEGIN</span> <span class="op">{</span> inside<span class="op">=</span><span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="extract-yaml-metadata-2"><a href="#extract-yaml-metadata-2" aria-hidden="true" tabindex="-1"></a>   <span class="ot">/</span><span class="ss">---</span><span class="ot">/</span> <span class="op">{</span><span class="cf">if</span> <span class="op">(</span>inside <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> inside<span class="op">=</span><span class="dv">1</span><span class="op">;</span> <span class="op">}</span></span>
<span id="extract-yaml-metadata-3"><a href="#extract-yaml-metadata-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> <span class="op">{</span> inside<span class="op">=</span><span class="dv">0</span><span class="op">;</span> <span class="op">};</span></span>
<span id="extract-yaml-metadata-4"><a href="#extract-yaml-metadata-4" aria-hidden="true" tabindex="-1"></a><span class="kw">next</span><span class="op">;</span></span>
<span id="extract-yaml-metadata-5"><a href="#extract-yaml-metadata-5" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="extract-yaml-metadata-6"><a href="#extract-yaml-metadata-6" aria-hidden="true" tabindex="-1"></a>   <span class="op">{</span> <span class="cf">if</span> <span class="op">(</span>inside <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span> <span class="kw">print</span> <span class="dt">$0</span><span class="op">;</span> <span class="op">};</span> <span class="op">}</span></span></code></pre></div>
</div>
<div class="ui segment">
<div class="ui top right attached label">
yaml
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml SourceCode"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">title</span><span class="kw">:</span><span class="at"> ブログの見た目を整える</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">author</span><span class="kw">:</span><span class="at"> Cj-bc</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tags</span><span class="kw">:</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> hakyll</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> ブログ</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> haskell</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">date</span><span class="kw">:</span><span class="at"> Jan 03, 2021</span></span></code></pre></div>
</div>
<h2 id="2. Yaml部分からメタデータを取得する">2.
Yaml部分からメタデータを取得する</h2>
<p>先程のawkスクリプトを適用してあげて…</p>
<div class="ui segment">
<div class="ui top right attached label">
bash
</div>
<div class="sourceCode" id="cb2" data-org-language="sh"><pre class="sourceCode bash SourceCode"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="bu">let</span> <span class="va">target</span> <span class="op">=</span> <span class="er">(</span><span class="cf">if</span> <span class="kw">(</span><span class="va">$nu</span><span class="ex">.env</span> <span class="kw">|</span> <span class="cf">select</span> TARGET <span class="kw">|</span> <span class="ex">empty?</span><span class="kw">)</span> <span class="ex">{</span><span class="st">&quot;&quot;</span><span class="ex">}</span> {<span class="va">$nu</span>.env.TARGET}<span class="kw">)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">(</span><span class="va">$target</span> <span class="kw">|</span> <span class="ex">empty?</span><span class="kw">)</span> <span class="kw">{</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">^echo</span> <span class="st">&quot;usage: TARGET=&lt;TARGET_FILENAME&gt; blog-migration-script--createHeader.nu&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span> <span class="ex">{}</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="bu">let</span> <span class="va">metadata</span> <span class="op">=</span> <span class="er">(</span><span class="fu">awk</span> <span class="st">'</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="st">&lt;&lt;extract-yaml-metadata&gt;&gt;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="st">'</span> <span class="va">$target</span> <span class="kw">|</span> <span class="ex">from</span> yaml<span class="kw">)</span></span></code></pre></div>
</div>
<div class="ui segment">
<div class="ui top right attached label">
bash
</div>
<div class="sourceCode" id="cb3" data-org-language="sh" data-tangle="no" data-shebang="#!/bin/nu"><pre class="sourceCode bash SourceCode"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;migration-script&gt;&gt;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">echo </span><span class="va">$metadata</span></span></code></pre></div>
</div>
<p>───────────────────────────────────────────────────────────────────────
0 ブログの見た目を整える Cj-bc [table 3 rows] Jan 03, 2021</p>
<h2 id="3. メタデータを加工して新しいヘッダーを作成する">3.
メタデータを加工して新しいヘッダーを作成する</h2>
<p>さて、これで投稿のタイトルと諸々のデータは取れるようになりました。
あとはこれを加工して、新しいヘッダーを作成します。</p>
<div class="ui segment">
<div class="ui top right attached label">
bash
</div>
<div class="sourceCode" id="cb4" data-org-language="sh"><pre class="sourceCode bash SourceCode"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>   <span class="op">&lt;&lt;nu-getAuthor&gt;&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="st">   &lt;&lt;nu-formatTags&gt;&gt;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="st">   &lt;&lt;nu-formatDate&gt;&gt;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="st">   echo $&quot;* (</span><span class="va">$metadata</span><span class="st">.title)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="st">:PROPERTIES:</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="st">:DATE: (formatDate </span><span class="va">$metadata</span><span class="st">)</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="st">:TAGS: (</span><span class="va">$metadata</span><span class="st">.tags | reduce -f ':' { </span><span class="va">$acc</span><span class="st"> + </span><span class="va">$it</span><span class="st"> + ':' })</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="st">:AUTHOR: (getAuthor </span><span class="va">$metadata</span><span class="st">)</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="st">:BLOG_POST_KIND: Memo</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="st">:BLOG_POST_PROGRESS: Published</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="st">:BLOG_POST_STATUS: Normal</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="st">:END:</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="st">   &quot;</span></span></code></pre></div>
</div>
<div class="ui segment">
<div class="ui top right attached label">
bash
</div>
<div class="sourceCode" id="cb5" data-org-language="sh" data-tangle="no"><pre class="sourceCode bash SourceCode"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;migration-script&gt;&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="st">echo </span><span class="va">$newHeading</span></span></code></pre></div>
</div>
<ul>
<li>ブログの見た目を整える</li>
</ul>
<ol>
<li><p>タグをOrg形式に変換する</p>
<p>org形式のタグはタグ名を <code>:</code> で囲んだものになります。
タグ名はメタデータ内にリストとして持っているので、nushellの
<code>reduce</code> コマンドで整形します。</p>
<div class="ui segment">
<div class="ui top right attached label">
bash
</div>
<div class="sourceCode" id="cb6" data-org-language="sh"><pre class="sourceCode bash SourceCode"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>   <span class="ex">def</span> formatTags [tags: table] {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="va">$tags</span> <span class="kw">|</span> <span class="ex">reduce</span> <span class="at">-f</span> <span class="st">':'</span> { <span class="va">$acc</span> + <span class="va">$it</span> + <span class="st">':'</span> }</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>   <span class="er">}</span></span></code></pre></div>
</div>
<div class="ui segment">
<div class="ui top right attached label">
bash
</div>
<div class="sourceCode" id="cb7" data-org-language="sh" data-tangle="no"><pre class="sourceCode bash SourceCode"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;&lt;nu-formatTags&gt;&gt;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="st">formatTags </span><span class="va">$metadata</span><span class="st">.tags</span></span></code></pre></div>
</div>
<p>:hakyll:ブログ:haskell:</p></li>
<li><p>記事の日付を変換する</p>
<p>昔のフォーマットでは <code>月 日, 年</code> となっているので、これを
org形式の <code>[年-月-日 曜日]</code> に変換します。</p>
<p>最初は nushell の <code>parse</code>
コマンドでパースしてうんたら…って
考えていたけれど、曜日を出す方法や月番号周りの変換に悩んでいました。
で、その間に GNU coreutils の <code>date</code>
コマンド(nushellは組込みで <code>date</code>
コマンド持っているが、そっちではない)が全ての仕事を出来そうだとわかったので
こちらでやることにしました。</p>
<p>GNU coreutilsの <code>date</code>
コマンドはデフォルトでは現在時刻を吐きますが、 <code>--date</code>
オプションに文字列を渡してあげることで別の日付にすることが可能です。
このオプションに元の文字列をセットして、それをorg形式にフォーマットしなおします。</p>
<p>nushellでは、前述の通りそれ自体が提供している <code>date</code>
コマンドが存在し、 GNU coreutilsの <code>date</code>
コマンドはそのままでは使用することができません。 そのため、<a href="https://www.nushell.sh/book/escaping.html">nushell bookの"Escaping
to the System"</a>を参考にコマンド名の前に <code>^</code>
を付けることでnushell独自のコマンドを呼び出さず、GNU coreutilsの
<code>date</code> コマンドを呼びだします。</p>
<p>尚、GNU coreutilsの <code>date</code> コマンドは環境変数
<code>LANG</code> に応じて曜日名の
出力などを変化させます。ここでは英語表記になってほしいので
<code>LANG=C</code> にしています。</p>
<div class="ui segment">
<div class="ui top right attached label">
bash
</div>
<div class="sourceCode" id="cb8" data-org-language="sh" data-tangle="no" data-noweb-ref="nu-formatDate"><pre class="sourceCode bash SourceCode"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>   <span class="ex">def</span> formatDate <span class="pp">[</span><span class="ss">metadata</span><span class="pp">]</span> {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="va">LANG</span><span class="op">=</span>C <span class="ex">^date</span> <span class="at">--date</span> <span class="st">$&quot;(</span><span class="va">$metadata</span><span class="st">.date)&quot;</span> +[%Y-%m-%d %a] <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-d</span> <span class="st">'\n'</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>   <span class="er">}</span></span></code></pre></div>
</div>
<p>"[2021-01-03 Sun]"</p></li>
<li><p>デフォルトの筆者を設定する</p>
<p>いくつかの記事はAUTHORが記載されていないので、
その場合はデフォルト値を使うようにしてあげます。</p>
<div class="ui segment">
<div class="ui top right attached label">
bash
</div>
<div class="sourceCode" id="cb9" data-org-language="sh" data-tangle="no" data-noweb-ref="nu-getAuthor"><pre class="sourceCode bash SourceCode"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>    <span class="ex">def</span> getAuthor <span class="pp">[</span><span class="ss">metadata</span><span class="pp">]</span> {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">(</span><span class="va">$metadata</span> <span class="kw">|</span> <span class="cf">select</span> author <span class="kw">|</span> <span class="ex">empty?</span><span class="kw">)</span> <span class="kw">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;Cj-bc&quot;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span> <span class="kw">{</span> <span class="va">$metadata</span><span class="ex">.author</span> }</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">}</span></span></code></pre></div>
</div></li>
</ol>
<h2 id="4. 元の記事を一段階下げる">4. 元の記事を一段階下げる</h2>
<p>さて、今迄作ってきたheadingを、元の記事と組合せる前段階をします。
トップレベル(level1)のheadingは一つだけであってほしいので、
元の記事のレベルを一段階下げます。これはpandocを用いて行うことができます。</p>
<p>但し、その前にYAMLヘッダーを取り除いてあげます。</p>
<div class="ui segment">
<div class="ui top right attached label">
awk
</div>
<div class="sourceCode" id="cb10" data-in-file="./2021-05-14-haskell-make-Ixed-instance.org" wrap="src org" data-noweb-ref="awk-trim-yaml-header"><pre class="sourceCode awk SourceCode"><code class="sourceCode awk"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>     <span class="cf">BEGIN</span> <span class="op">{</span> inside<span class="op">=</span><span class="dv">0</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>     <span class="ot">/</span><span class="ss">---</span><span class="ot">/</span> <span class="op">{</span><span class="cf">if</span> <span class="op">(</span>inside <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> inside<span class="op">=</span><span class="dv">1</span><span class="op">;</span> <span class="op">}</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> <span class="op">{</span> inside<span class="op">=</span><span class="dv">2</span><span class="op">;</span> <span class="op">};</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="kw">next</span><span class="op">;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>     <span class="op">}</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>     <span class="op">{</span> <span class="cf">if</span> <span class="op">(</span>inside <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span> <span class="kw">print</span> <span class="dt">$0</span><span class="op">;</span> <span class="op">};</span> <span class="op">}</span></span></code></pre></div>
</div>
<div class="ui segment">
<div class="ui top right attached label">
org
</div>
<div class="sourceCode" id="cb11"><pre class="sourceCode org SourceCode"><code class="sourceCode orgmode"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>     * <span class="in">~Ixed~</span> とは</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>     数学的解説はわかりませんごめんなさい。誰か補足があれば <span class="ot">[[https://github.com/Cj-bc/blog][blogのレポジトリ]]</span> にissueでも残してください()</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>     Haskellなのでとりあえず hoogleを参照します。</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>     <span class="in">~Ixed~</span> の定義は以下の通りです</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>     #+begin_src haskell</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>class Ixed m where</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  -- |</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  -- /NB:/ Setting the value of this 'Traversal' will only set the value in</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  -- 'at' if it is already present.</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  --</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  -- If you want to be able to insert /missing/ values, you want 'at'.</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  --</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  -- &gt;&gt;&gt; Seq.fromList <span class="ot">[a,b,c,d</span>] &amp; ix 2 %~ f</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  -- fromList <span class="ot">[a,b,f c,d</span>]</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  --</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  -- &gt;&gt;&gt; Seq.fromList <span class="ot">[a,b,c,d</span>] &amp; ix 2 .~ e</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  -- fromList <span class="ot">[a,b,e,d</span>]</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  --</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  -- &gt;&gt;&gt; Seq.fromList <span class="ot">[a,b,c,d</span>] ^? ix 2</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  -- Just c</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  --</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  -- &gt;&gt;&gt; Seq.fromList <span class="ot">[</span>] ^? ix 2</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>  -- Nothing</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  ix :: Index m -&gt; Traversal' m (IxValue m)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  default ix :: At m =&gt; Index m -&gt; Traversal' m (IxValue m)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>  ix = ixAt</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>  {-# INLINE ix #-}</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>     #+end_src</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>     <span class="in">~Ixed~ は =Lens= の提供する型の一つで、 ~Map~</span> のような型の値に対して</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>     値を <span class="in">~traverse~ するシンプルな ~Traversal~</span> を提供するものです。</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>     簡潔に言うと、</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>     *リスト等の要素にLensでアクセスできるようにするやつ*</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>     みたいなざっくりとした理解をしています。</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>     また、これに関連するオープンな型ファミリーとして <span class="in">~Index~ と ~IxValue~</span> があります</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>     #+begin_src haskell</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>type family Index (s :: *) :: *</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>-- | This provides a common notion of a value at an index that is shared by both 'Ixed' and 'At'.</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>type family IxValue (m :: *) :: *</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>     #+end_src</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>     <span class="in">~Ixed~ において、 ~Index~ はインデックスの型、 ~IxValue~</span> はそこに格納されている</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>     値の型です。</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>     * 作る</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>     とりあえず作り始めます。</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>     前提として、今回<span class="in">~Ixed~</span>のインスタンスを作るのは以下の型です。</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>     元のファイルは <span class="ot">[[https://github.com/Cj-bc/playground/blob/0fb982f28f7ab0444ffd2ad59eacc3cd904b99ba/haskell/hit-n-blow/src/HitNBlow/Type.hs#L15-20][Cj-bc/playground -- hit-n-blow]]</span> で使われているものです。</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>     #+begin_src haskell</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>-- | Represents each Pin</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>data Pin = Red | Blue | Green | White | Purple deriving (Show)</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>-- | One Set of Pins that user will guess </span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>data Lane = Lane (Maybe Pin) (Maybe Pin) (Maybe Pin) (Maybe Pin) (Maybe Pin)</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    deriving (Show)</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>     #+end_src</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>     <span class="in">~Ixed~ の定義に特に制限がかかれていないので、 ~ix~</span> を定義することにします。</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>     そのために、 <span class="in">~ix~ で使用される ~Index~ と ~IxValue~</span> を定義することにします。</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>     ** Index</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a> <span class="in">~Index~</span> はあまり説明がありませんが、型の情報からすると恐らく「添字に使う型」</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a> の定義であろうと推測が出来ます。</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a> (名前が <span class="in">~Index~ であること、 ~ix~</span> において最初に取ること等。又、</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a> 既にあるインスタンスを確認するのも良い方法だと思います。)</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a> <span class="in">~Lane~ において添字は ~Int~</span> です。</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a> #+begin_src haskell</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>   type instance Index Lane = Int</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a> #+end_src</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>     ** IxValue</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a> 同様ですが、今度はそれぞれの中身の型を定義します。</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a> #+begin_src haskell</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>   type instance IxValue Lane = Maybe Pin</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a> #+end_src</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>     ** Ixed</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a> <span class="in">~Ixed~</span> 本体に行きます!!</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a> <span class="in">~ix~</span> の型は</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a> #+begin_src haskell</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>   ix :: Index m -&gt; Traversal' m (IxValue m)</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a> #+end_src</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a> で、今回は <span class="in">~m~ が ~Lane~</span> なので具体的な型にすると</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a> #+begin_src haskell</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>   ix :: Int -&gt; Traversal' Lane (Maybe Pin)</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a> #+end_src</span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a> ということになります。</span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a> で、 <span class="in">~Lens~</span> 少ししか分からんので一つ疑問が浮かびます</span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a> *&gt;&gt;&gt;&gt;&gt; ~Traversal'~ ってナニよ!!!!! &lt;&lt;&lt;&lt;&lt;*</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>     ** Traversal' ってナニよ!</span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a> はい。名前は知ってるけど使い方良く分からずに放置してた子ですね。</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a> 定義によると</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a> #+begin_src haskell</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>   type Traversal' s a = Traversal s s a a</span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>   type Traversal s t a b = forall f. Applicative f =&gt; (a -&gt; f b) -&gt; s -&gt; f t</span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a> #+end_src</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a> ついでなので <span class="ot">[[https://hackage.haskell.org/package/lens-5.0.1/docs/Control-Lens-Type.html#t:Traversal][~Traversal~]]</span> の定義も載せておきました。</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a> <span class="in">~Lens~</span> と同じように、実体はただの関数ですね。</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a> <span class="in">~Lens~ よりも制限の緩い型で ~Traversable~ の型関数である ~traverse~</span> の一般化らしいです。</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a> しっかりと理解はしていないが、まぁ型を考えれば作れてしまうのでとりあえずは</span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a> ふんわりと掴んだ状態で作ってみます。</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a> あ、ちなみに <span class="in">~Traversal'~</span> は単純に、値の更新等した時に型が変化しないものですね。</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a> 参考:</span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a><span class="ss"> - </span>[[https://fumieval.hatenablog.com/entry/2015/07/14/223329][lensパッケージのオプティクス(弱い順) -- モナドとわたしとコモナド]]</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>     ** <span class="in">~ix~</span> を作る</span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a> さて、 <span class="in">~Traversal'~ がわかったので ~ix~</span> を作れ(る気がし)ます。</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a> <span class="in">~Traversal'~</span> を置き換えてみると:</span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a> #+begin_src haskell</span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>   ix :: Int -&gt; Traversa' Lane (Maybe Pin)</span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>   ix :: Int -&gt; Traversal Lane Lane (Maybe Pin) (Maybe Pin)</span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>   ix :: Int -&gt; (forall f. Applicative f =&gt; (Maybe Pin -&gt; f (Maybe Pin) -&gt; Lane -&gt; f Lane</span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a> #+end_src</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a> となります(forallの位置は少し自信がないけど多分あってる)</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a> <span class="in">~Int~ は元々 ~Index m~</span> だった部分なので、今興味のあるインデックス(に該当する数字)が来るのがわかります。</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a> 又、元の <span class="in">~Traversal'~ の部分も要は「中身( ~Maybe Pin~</span> )に作用する関数を受け取り、作用させた</span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a> 結果を返す」わけなので、その通りに実装します。</span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a> #+begin_src haskell</span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>   instance Ixed Lane where</span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>     ix 1 = \g l@(Lane a b c d e) -&gt; Lane &lt;$&gt; g a &lt;*&gt; b &lt;*&gt; c &lt;*&gt; d &lt;*&gt; e</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>     ix 2 = \g l@(Lane a b c d e) -&gt; Lane a &lt;$&gt; g b &lt;*&gt; c &lt;*&gt; d &lt;*&gt; e</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>     ix 3 = \g l@(Lane a b c d e) -&gt; Lane a b &lt;$&gt; g c &lt;*&gt; d &lt;*&gt; e</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>     ix 4 = \g l@(Lane a b c d e) -&gt; Lane a b c &lt;$&gt; g d &lt;*&gt; e</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>     ix 5 = \g l@(Lane a b c d e) -&gt; Lane a b c d &lt;$&gt; g e</span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>     ix _ = \_ l -&gt; pure l</span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a> #+end_src</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a> 多分動いた!!</span></code></pre></div>
</div>
<div class="ui segment">
<div class="ui top right attached label">
bash
</div>
<div class="sourceCode" id="pandocを用いたheadingレベル下げの例" data-org-language="sh" data-shbang="#!/bin/bash" data-tangle="no"><pre class="sourceCode bash SourceCode"><code class="sourceCode bash"><span id="pandocを用いたheadingレベル下げの例-1"><a href="#pandocを用いたheadingレベル下げの例-1" aria-hidden="true" tabindex="-1"></a>     <span class="ex">pandoc</span> <span class="at">-f</span> org <span class="at">--shift-heading-level-by</span><span class="op">=</span>1 <span class="at">-t</span> org <span class="op">&lt;(</span><span class="bu">echo</span> <span class="st">&quot;</span></span>
<span id="pandocを用いたheadingレベル下げの例-2"><a href="#pandocを用いたheadingレベル下げの例-2" aria-hidden="true" tabindex="-1"></a><span class="st">     * Leve1 header example</span></span>
<span id="pandocを用いたheadingレベル下げの例-3"><a href="#pandocを用いたheadingレベル下げの例-3" aria-hidden="true" tabindex="-1"></a><span class="st">hello!</span></span>
<span id="pandocを用いたheadingレベル下げの例-4"><a href="#pandocを用いたheadingレベル下げの例-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="pandocを用いたheadingレベル下げの例-5"><a href="#pandocを用いたheadingレベル下げの例-5" aria-hidden="true" tabindex="-1"></a><span class="st">     ** Inner level2 header</span></span>
<span id="pandocを用いたheadingレベル下げの例-6"><a href="#pandocを用いたheadingレベル下げの例-6" aria-hidden="true" tabindex="-1"></a><span class="st">     &quot;</span><span class="op">)</span></span>
<span id="pandocを用いたheadingレベル下げの例-7"><a href="#pandocを用いたheadingレベル下げの例-7" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
</div>
<p>** Leve1 header example</p>
<p>hello!</p>
<p><strong>*</strong> Inner level2 header</p>
<h2 id="5. 3.と4.を組み合わせる">5. 3.と4.を組み合わせる</h2>
<p>ここからはbashを使います。</p>
<div class="ui segment">
<div class="ui top right attached label">
bash
</div>
<div class="sourceCode" id="cb12" data-org-language="sh" data-shebang="#!/bin/bash"><pre class="sourceCode bash SourceCode"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>   <span class="kw">[[</span> <span class="ot">-z</span> <span class="va">$1</span> <span class="kw">]]</span> <span class="kw">&amp;&amp;</span> <span class="kw">{</span> <span class="bu">echo</span> <span class="st">&quot;usage: migration-script.sh TARGETFILE&quot;</span><span class="kw">;</span> <span class="bu">exit</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>   <span class="va">target</span><span class="op">=</span><span class="va">$1</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>   <span class="va">extensions</span><span class="op">=</span><span class="va">(</span>emoji task_lists</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a> backtick_code_blocks fenced_code_attributes</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a> header_attributes raw_html</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="va">)</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">function</span><span class="fu"> formatExtension()</span> <span class="kw">{</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;+</span><span class="va">${extensions</span><span class="op">[@]</span><span class="va">}</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="st">' '</span> <span class="st">'+'</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>   <span class="kw">}</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>   <span class="va">format</span><span class="op">=</span><span class="va">$(filename</span><span class="op">=</span><span class="va">($(</span><span class="bu">echo</span> <span class="va">$target</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-s</span> <span class="st">'.'</span> <span class="st">' '</span><span class="va">))</span><span class="kw">;</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>     <span class="cf">case</span> <span class="st">&quot;</span><span class="va">${filename</span><span class="op">[</span>-1<span class="op">]</span><span class="va">}</span><span class="st">&quot;</span> <span class="kw">in</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;md&quot;</span><span class="kw">)</span> <span class="bu">echo</span> <span class="st">&quot;markdown</span><span class="va">$(</span><span class="ex">formatExtension</span><span class="va">)</span><span class="st">&quot;</span><span class="cf">;;</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="pp">*</span><span class="kw">)</span> <span class="bu">echo</span> <span class="st">&quot;org&quot;</span><span class="cf">;;</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>     <span class="cf">esac</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="va">)</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>   <span class="fu">cat</span> <span class="op">&lt;(</span><span class="va">TARGET</span><span class="op">=</span><span class="va">$target</span> <span class="ex">./blog-migration-script--createHeader.nu</span><span class="op">)</span> <span class="op">&lt;(</span><span class="fu">awk</span> <span class="st">'</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="st">   &lt;&lt;awk-trim-yaml-header&gt;&gt;</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="st">   '</span> <span class="va">$target</span> <span class="kw">|</span> <span class="ex">pandoc</span> <span class="at">-f</span> <span class="st">&quot;</span><span class="va">${format}</span><span class="st">&quot;</span> <span class="at">--shift-heading-level-by</span><span class="op">=</span>1 <span class="at">-t</span> org<span class="op">)</span></span></code></pre></div>
</div>
<p>usage: migration-script.sh TARGETFILE</p>
<ol>
<li><p>ここでnushellを使わなかった理由</p>
<p>nushellの <code>echo</code> はListで出力してくるので、 GNU
coreutilsの <code>echo</code> を使います。 又、
<code>^echo $newHeading (pandoc...)</code> だと <code>$newHeading</code>
と <code>(pandoc...)</code> の間に改行が作成されず、
<code>$newHeading</code> の後ろに空行を追加して
おいてもなんか消されてしまうので以下のような方法を取っています。</p></li>
</ol>
<h2 id="7. 全ファイルに対して実行する">7.
全ファイルに対して実行する</h2>
<p>あとはこれを全てのファイルに対して実行してあげれば良いわけです! <span class="spurious-link" target="これまでの遷移"><em>これまでの遷移</em></span>から、
2021/05/19以前の投稿が古いフォーマットを使用している
ことがわかるので、それ以前のファイルのみを探し出します。</p>
<p>この取得はちょっと面倒で、昔のファイルでも最近変更していたりするので
<code>find</code> コマンドが使えません( <code>-newer</code>
系を使いたいが、一定の日付より前のみに 変更しているという根拠はない)。
しかし、私のブログは(ありがたいことに)ファイル名が日付で始まっているので、それをglob展開して取得することにします。</p>
<p>そしてその各ファイルに先程のスクリプトを適用してあげて、変形します。</p>
<ol>
<li><p>まずはGit管理されているファイルに実行する</p>
<p>ただ、念の為にまずはGitにコミットされているファイルのみを対象にします。コミットさえされていれば失敗しても大丈夫なので…
Gitに認識されていないファイルは <code class="sourceCode bash" data-org-language="sh"><span class="fu">git</span> status <span class="at">--short</span> FILENAME</code>
が <code>?? &lt;ファイル名&gt;</code> となるので、それを使って
判定します。</p>
<div class="ui segment">
<div class="ui top right attached label">
bash
</div>
<div class="sourceCode" id="cb13" data-org-language="sh" wrap="accordion"><pre class="sourceCode bash SourceCode"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>   <span class="kw">function</span><span class="fu"> filter</span> <span class="kw">{</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="bu">local</span> <span class="va">filterFunction</span><span class="op">=</span><span class="va">$1</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="bu">read</span> <span class="va">candidate</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">$filterFunction</span> <span class="st">&quot;</span><span class="va">$candidate</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">&amp;&amp;</span> <span class="bu">echo</span> <span class="st">&quot;</span><span class="va">$candidate</span><span class="st">&quot;</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span> <span class="op">&lt;</span> <span class="op">&lt;(</span><span class="fu">cat</span> /dev/stdin<span class="op">)</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">}</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>   <span class="kw">function</span><span class="fu"> map</span> <span class="kw">{</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="bu">local</span> <span class="va">f</span><span class="op">=</span><span class="va">$1</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="bu">read</span> <span class="va">target</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">$f</span> <span class="st">&quot;</span><span class="va">$target</span><span class="st">&quot;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span> <span class="op">&lt;</span> <span class="op">&lt;(</span><span class="fu">cat</span> /dev/stdin<span class="op">)</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>   <span class="kw">}</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>   <span class="kw">function</span><span class="fu"> filterGitKnownFile</span> <span class="kw">{</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="bu">local</span> <span class="va">filename</span><span class="op">=</span><span class="va">$1</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="bu">local</span> <span class="va">gitStatusResult</span><span class="op">=</span><span class="st">&quot;</span><span class="va">$(</span><span class="fu">git</span> status <span class="at">--short</span> <span class="va">$filename)</span><span class="st">&quot;</span> </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="kw">[[</span> <span class="ot">!</span> <span class="st">&quot;</span><span class="va">$gitStatusResult</span><span class="st">&quot;</span> <span class="kw">]]</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>   <span class="kw">}</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>   <span class="kw">function</span><span class="fu"> convertFile</span> <span class="kw">{</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="bu">local</span> <span class="va">target</span><span class="op">=</span><span class="va">$1</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="ex">./migration-script.sh</span> <span class="va">$target</span> <span class="op">&gt;</span> <span class="va">${target}</span>.new</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> <span class="va">${target}</span>.new <span class="va">$target</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>   <span class="kw">}</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>   <span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ls</span> 2020-<span class="pp">*</span> 2021-0<span class="dt">{1</span><span class="op">,</span><span class="dt">2</span><span class="op">,</span><span class="dt">3</span><span class="op">,</span><span class="dt">4}</span><span class="pp">*</span> <span class="kw">|</span> <span class="fu">grep</span> <span class="st">&quot;\(md\|org\)$&quot;</span> <span class="kw">|</span> <span class="ex">filter</span> <span class="st">&quot;filterGitKnownFile&quot;</span>  <span class="kw">|</span> <span class="ex">map</span> convertFile</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>   <span class="ex">convertFile</span> 2021-05-04-xmonad-use-stack-for-compile.org</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>   <span class="ex">convertFile</span> 2021-05-10-xmonad-list-of-layouts.org </span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>   <span class="bu">echo</span> <span class="st">&quot;Finished!&quot;</span></span></code></pre></div>
</div>
<div class="accordion">
<p>Finished!</p>
</div></li>
</ol>
    </div>
  </div>
  

</div>

	    </div>
	  </div>

	  <div class="ui four wide column">
	  </div>
	</div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
